{ debounce } = require 'underscore'
{ trim } = require 'underscore.string'
{ API_URL } = require('sharify').data
Q = require 'bluebird-q'
Backbone = require 'backbone'
analyticsHooks = require '../../../../lib/analytics_hooks.coffee'
Artist = require '../../../../models/artist.coffee'
CurrentUser = require '../../../../models/current_user.coffee'
Match = require '../../../../collections/match.coffee'
{ Following } = require '../../../../components/follow_button/index.coffee'
itemTemplate = -> require('./templates/result.jade') arguments...
resultsTemplate = -> require('./templates/results.jade') arguments...

module.exports = class SearchArtistsView extends Backbone.View
  events:
    'keyup input': 'maybeSearch'
    'click .tt-suggestion-inner' : 'followAndSwap'

  maybeSearch: debounce (-> @search()), 200

  input: ->
    @$input ?= @$('input')

  emptyInput: ->
    trim(@input().val()) == ""

  initialize: ({ @initialSuggestions, @followedArtists }) ->
    @match = new Match
    @match.kind = 'artists'

    @user = CurrentUser.orNull()
    @following = new Following(null, kind: 'artist') if @user

    @listenTo @initialSuggestions, 'add', @renderResults
    @listenTo @match, 'sync reset', @renderResults

    @pastMatches = new Backbone.Collection

    @input().focus()

  renderResults: ->
    suggestions = if @match.models.length then @match.models else @initialSuggestions.models
    @$('.arbv-follow-results').html resultsTemplate
      suggestions: suggestions

  search: ->
    return @match.reset() if @emptyInput()
    @match.fetch data: term: @input().val(), size: 4

  findReplacement: (id, cb) ->
    artists = new Backbone.Collection [], model: Artist
    artists.url = "#{API_URL}/api/v1/me/suggested/artists"
    artists.fetch
      success: cb
      data:
        exclude_followed_artists: true
        artist_id: id
        exclude_artists_without_artworks: true
        size: 1

  findReplacementAndWait: (id) ->
    replacement = new Promise (resolve) => @findReplacement id, resolve
    Q.all [replacement, Q.delay(500)]

  replaceRow: ($el, id, artist) ->
    html = itemTemplate suggestion: artist
    $newRow = $(html).find('.tt-suggestion-inner').css 'display', 'none'
    $el.parent().append $newRow
    $el.fadeOut =>
      $el.next().fadeIn 500, -> $el.remove()
      @appendName id

  removeRow: ($el, id) ->
    $el.parent().fadeOut =>
      $el.parent().remove()
      @appendName id

  appendName: (id) ->
    followed = @match.get(id) or @initialSuggestions.get(id) or @pastMatches.get(id)
    @followedArtists.unshift followed

  followAndSwap: (e) ->
    e.preventDefault()
    $suggestion = $(e.currentTarget)
    id = $suggestion.data('artist-id')
    @following.follow(id) if @user
    $suggestion.find('.typeahead-suggestion-follow').attr 'data-state', 'following'
    analyticsHooks.trigger 'followable:followed',  {
      modelName: @match.kind
      entity_slug: id
      context_module: 'Homepage followed artists'
    }
    $suggestion.addClass 'tt-suggestion-inner__selected'
    @$('input').select()
    @findReplacementAndWait(id).then ([ artists ]) =>
      if artists.length
        @replaceRow($suggestion, id, artists.first())
        @pastMatches.add artists.first()
      else
        @removeRow $suggestion, id

